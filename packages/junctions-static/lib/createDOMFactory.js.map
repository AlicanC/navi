{"version":3,"sources":["../src/createDOMFactory.js"],"names":["createDOMFactory","jsdom","require","mainFile","publicFolder","cwd","process","source","readFileSync","resolve","script","Script","displayErrors","filename","timeout","factory","onLoad","doc","resourceLoader","resource","callback","pathname","url","console","error","exit","relativePathname","slice","filesystemPath","test","readFile","err","data","defaultFetch","window","defaultView","evalVMScript","testDOM","rootJunction"],"mappings":";;;;;kBAMwBA,gB;;AANxB;;;;AACA;;;;AACA;;;;;;AACA,IAAMC,QAAQC,QAAQ,sBAAR,CAAd;;AAGe,SAASF,gBAAT,CAA0BG,QAA1B,EAAoCC,YAApC,EAAkD;AAC7D,QAAIC,MAAMC,QAAQD,GAAR,EAAV;AACA,QAAIE,SAAS,aAAGC,YAAH,CAAgB,eAAKC,OAAL,CAAaJ,GAAb,EAAkBF,QAAlB,CAAhB,CAAb;AACA,QAAIO,SAAS,IAAI,aAAGC,MAAP,CAAcJ,MAAd,EAAsB;AAC/BK,uBAAe,IADgB;AAE/BC,kBAAU,SAFqB;AAG/BC,iBAAS;AAHsB,KAAtB,CAAb;;AAMA,QAAIC,UAAU,SAAVA,OAAU,CAACC,MAAD,EAAY;AACtB,YAAIC,MAAMhB,MAAMA,KAAN,CAAY,EAAZ,EAAgB;AACtBiB,4BAAgB,wBAAUC,QAAV,EAAoBC,QAApB,EAA8B;AAC1C,oBAAIC,WAAWF,SAASG,GAAT,CAAaD,QAA5B;;AAEA,oBAAI,CAACjB,YAAL,EAAmB;AACfmB,4BAAQC,KAAR,+BAA0CH,QAA1C;AACAf,4BAAQmB,IAAR,CAAa,CAAb;AACH;;AAED,oBAAIC,mBAAmBL,SAAS,CAAT,MAAgB,GAAhB,GAAsBA,SAASM,KAAT,CAAe,CAAf,CAAtB,GAA0CN,QAAjE;AACA,oBAAIO,iBAAiB,eAAKnB,OAAL,CAAaJ,GAAb,EAAkBD,YAAlB,EAAgCsB,gBAAhC,CAArB;;AAEA,oBAAI,QAAQG,IAAR,CAAaR,QAAb,CAAJ,EAA4B;AACxB,iCAAGS,QAAH,CAAYF,cAAZ,EAA4B,MAA5B,EAAoC,UAACG,GAAD,EAAMC,IAAN,EAAe;AAC/C,4BAAID,GAAJ,EAAS;AACL,mCAAOX,SAASW,GAAT,CAAP;AACH;;AAED,4BAAIf,MAAJ,EAAY;AACRA,mCAAOK,QAAP;AACH;;AAEDD,iCAAS,IAAT,EAAe,oBAAoBY,IAAnC;AACH,qBAVD;AAWH,iBAZD,MAaK;AACD,2BAAOb,SAASc,YAAT,CAAsBb,QAAtB,CAAP;AACH;AACJ;AA5BqB,SAAhB,CAAV;AA8BA,YAAIc,SAASjB,IAAIkB,WAAjB;AACAlC,cAAMmC,YAAN,CAAmBF,MAAnB,EAA2BxB,MAA3B;AACA,eAAOwB,MAAP;AACH,KAlCD;;AAoCA,QAAIG,UAAUtB,SAAd;AACA,QAAIuB,eAAeD,QAAQH,MAAR,CAAeI,YAAlC;AACA,QAAI,CAACA,YAAL,EAAmB;AACff,gBAAQC,KAAR,gBAA2BrB,QAA3B;AACAG,gBAAQmB,IAAR,CAAa,CAAb;AACH;;AAED,WAAOV,OAAP;AACH","file":"createDOMFactory.js","sourcesContent":["import fs from 'fs'\nimport path from 'path'\nimport vm from 'vm'\nconst jsdom = require('jsdom/lib/old-api.js')\n\n\nexport default function createDOMFactory(mainFile, publicFolder) {\n    let cwd = process.cwd()\n    let source = fs.readFileSync(path.resolve(cwd, mainFile))\n    let script = new vm.Script(source, {\n        displayErrors: true,\n        filename: 'main.js',\n        timeout: 1000,\n    })\n\n    let factory = (onLoad) => {\n        let doc = jsdom.jsdom('', {\n            resourceLoader: function (resource, callback) {\n                var pathname = resource.url.pathname\n\n                if (!publicFolder) {\n                    console.error(`Your app requested file \"${pathname}\", but I don't know where to look! Try setting the --public option.`)\n                    process.exit(1)\n                }\n\n                let relativePathname = pathname[0] === '/' ? pathname.slice(1) : pathname\n                let filesystemPath = path.resolve(cwd, publicFolder, relativePathname)\n\n                if (/\\.js$/.test(pathname)) {\n                    fs.readFile(filesystemPath, \"utf8\", (err, data) => {\n                        if (err) {\n                            return callback(err)\n                        }\n\n                        if (onLoad) {\n                            onLoad(pathname)\n                        }\n\n                        callback(null, '\"use strict\";\\n' + data)\n                    })\n                }\n                else {\n                    return resource.defaultFetch(callback)\n                }\n            },\n        });\n        let window = doc.defaultView\n        jsdom.evalVMScript(window, script)\n        return window\n    }\n\n    let testDOM = factory()\n    let rootJunction = testDOM.window.rootJunction\n    if (!rootJunction) {\n        console.error(`The file \"${mainFile}\" was found, but doesn't assign a \"rootJunction\" property to the window object.`)\n        process.exit(1)\n    }\n    \n    return factory\n}\n"]}